<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>YLE Vocabulary Cards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ä½ è‡ªå·±çš„ CSS -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<h1>YLE Vocabulary Cards</h1>
<div class="subtitle">Starters / Movers / Flyers å–®å­—</div>

<div class="top-bar">
  <div class="level-tabs">
    <button class="level-tab level-starters active" data-level="starters">
      <span class="icon">ğŸŒ±</span> Starters
    </button>
    <button class="level-tab level-movers" data-level="movers">
      <span class="icon">ğŸš¶â€â™‚ï¸</span> Movers
    </button>
    <button class="level-tab level-flyers" data-level="flyers">
      <span class="icon">ğŸ•Šï¸</span> Flyers
    </button>
  </div>

  <button class="print-btn" id="printBtn">ğŸ–¨ï¸ åˆ—å°</button>
</div>

<!-- æœå°‹ -->
<div class="search-card">
  <input id="searchBox" type="text" placeholder="æœå°‹è‹±æ–‡ / ä¸­æ–‡ / è©æ€§" />
</div>

<div class="main-layout">
  <aside class="sidebar" id="sidebar">
    <div class="category-buttons">
      <div class="cat-title">
        ä¸»é¡Œé¸æ“‡ï¼ˆç›®å‰ï¼š<span id="currentLevelLabel">Starters</span>ï¼‰
      </div>

      <button class="cat-btn special active" data-cat="all">
        å…¨éƒ¨ä¸»é¡Œ <span class="count" id="countAll">0</span>
      </button>

      <button class="cat-btn special" data-cat="flat">
        ä¸åˆ†ä¸»é¡Œï¼ˆå…¨éƒ¨å–®å­—ï¼‰ <span class="count" id="countFlat">0</span>
      </button>

      <div id="categoryList"></div>
    </div>
  </aside>

  <main class="content">
    <div class="word-panel">
      <div class="panel-title">
        <div>
          <span class="panel-title-main" id="panelTitle">å…¨éƒ¨ä¸»é¡Œ</span>
          <span class="panel-title-sub" id="panelSubtitle">é¡¯ç¤ºæ‰€æœ‰ä¸»é¡Œèˆ‡å–®å­—</span>
        </div>
        <span class="panel-badge" id="panelBadge">Starters Â· 0 è©</span>
      </div>

      <div id="wordContent"></div>
    </div>
  </main>
</div>

<!-- è®€å–å¤–éƒ¨è³‡æ–™æª”ï¼ˆå…§å« window.STARTERS_DATA / window.MOVERS_DATA / window.FLYERS_DATAï¼‰ -->
<script src="data.js"></script>

<script>
/***********************
 * å¾ data.js è®€è³‡æ–™ï¼ˆæ²’è®€åˆ°å°±çµ¦ç©ºçš„ï¼Œé¿å…æ•´å€‹æ›æ‰ï¼‰
 ***********************/
const STARTERS_DATA = window.STARTERS_DATA || { categories: [] };
const MOVERS_DATA   = window.MOVERS_DATA   || { categories: [] };
const FLYERS_DATA   = window.FLYERS_DATA   || { categories: [] };

/***********************
 * LEVEL è¨­å®š
 ***********************/
const LEVEL_CONFIG = {
  starters: { label: "Starters", short: "S", icon: "ğŸŒ±" },
  movers:   { label: "Movers",   short: "M", icon: "ğŸš¶â€â™‚ï¸" },
  flyers:   { label: "Flyers",   short: "F", icon: "ğŸ•Šï¸" }
};

const DATASETS = {
  starters: STARTERS_DATA,
  movers:   MOVERS_DATA,
  flyers:   FLYERS_DATA
};

/***********************
 * ç‹€æ…‹
 ***********************/
let currentLevel = "starters";
let currentCategoryId = "all";
let searchKey = "";

/***********************
 * DOM
 ***********************/
const levelTabs          = document.querySelectorAll(".level-tab");
const currentLevelLabel  = document.getElementById("currentLevelLabel");
const categoryListEl     = document.getElementById("categoryList");
const countAllEl         = document.getElementById("countAll");
const countFlatEl        = document.getElementById("countFlat");
const panelTitleEl       = document.getElementById("panelTitle");
const panelSubtitleEl    = document.getElementById("panelSubtitle");
const panelBadgeEl       = document.getElementById("panelBadge");
const wordContentEl      = document.getElementById("wordContent");
const searchBox          = document.getElementById("searchBox");
const sidebar            = document.getElementById("sidebar");
const printBtn           = document.getElementById("printBtn");

/***********************
 * TTSï¼šå–®å­—ç™¼éŸ³ï¼ˆè·¨å¹³å°èª¿æ•´ï¼‰
 ***********************/
let selectedVoice = null;
let ttsAvailable  = typeof window !== "undefined" && "speechSynthesis" in window;

function initVoices() {
  if (!ttsAvailable) return;
  const voices = window.speechSynthesis.getVoices();
  if (!voices || !voices.length) return;

  selectedVoice =
    voices.find(v => v.name.includes("Google US English")) ||
    voices.find(v => v.name.includes("Google UK English")) ||
    voices.find(v => v.name.includes("Microsoft") && v.lang === "en-US") ||
    voices.find(v => v.lang === "en-US") ||
    voices.find(v => v.lang.startsWith("en")) ||
    voices[0];
}

if (ttsAvailable) {
  window.speechSynthesis.onvoiceschanged = initVoices;
  initVoices();
}

function speakWord(text) {
  if (!ttsAvailable) return;

  const u = new SpeechSynthesisUtterance(text);
  u.lang  = "en-US";
  u.rate  = 0.9;
  u.pitch = 1.0;

  if (selectedVoice) u.voice = selectedVoice;

  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

wordContentEl.addEventListener("click", (e) => {
  const btn = e.target.closest(".speak-btn");
  if (!btn) return;
  speakWord(btn.dataset.word);
});

/***********************
 * å·¥å…·
 ***********************/
function normalize(str) {
  return (str || "").trim().toLowerCase();
}

/** å–å¾—æŸä¸€å€‹ datasetï¼ˆå–®ä¸€ç­‰ç´šï¼‰çš„å…¨éƒ¨å–®å­— */
function getAllWords(dataset, levelId) {
  const cats = dataset.categories || [];
  const out = [];
  const levelLabel = LEVEL_CONFIG[levelId]?.label || "";
  const levelShort = LEVEL_CONFIG[levelId]?.short || "";
  cats.forEach(cat => {
    (cat.words || []).forEach(w => {
      out.push({
        ...w,
        categoryId:   cat.id,
        categoryLabel: cat.label,
        categoryIcon: cat.icon,
        levelId,
        levelLabel,
        levelShort
      });
    });
  });
  return out;
}

/** å–å¾—æ‰€æœ‰ç­‰ç´šï¼ˆStarters + Movers + Flyersï¼‰çš„å…¨éƒ¨å–®å­— */
function getAllWordsAllLevels() {
  let all = [];
  all = all.concat(getAllWords(STARTERS_DATA, "starters"));
  all = all.concat(getAllWords(MOVERS_DATA,   "movers"));
  all = all.concat(getAllWords(FLYERS_DATA,   "flyers"));
  return all;
}

/** å–®ä¸€ç­‰ç´šç”¨çš„ï¼ˆéæœå°‹æ™‚é¡¯ç¤ºç”¨ï¼‰ */
function getAllWordsForCurrentLevel() {
  const dataset = DATASETS[currentLevel];
  return getAllWords(dataset, currentLevel);
}

/** æœå°‹ï¼šè·¨ç­‰ç´šæœå°‹å…¨éƒ¨å–®å­— */
function filteredWordsAllLevels(key) {
  const k = normalize(key);
  if (!k) return getAllWordsAllLevels();
  return getAllWordsAllLevels().filter(w => {
    const t = `${w.en} ${w.zh || ""} ${w.pos || ""} ${w.levelLabel || ""}`.toLowerCase();
    return t.includes(k);
  });
}

/***********************
 * ä¸»é¡ŒæŒ‰éˆ•ï¼ˆåªç•« UIï¼Œäº‹ä»¶ç”¨ sidebar ä»£ç†ï¼‰
 ***********************/
function renderCategoryButtons() {
  const dataset = DATASETS[currentLevel];
  const cats = dataset.categories || [];

  categoryListEl.innerHTML = "";

  const allWords = getAllWordsForCurrentLevel();
  countAllEl.textContent  = allWords.length;
  countFlatEl.textContent = allWords.length;

  cats.forEach(cat => {
    const btn = document.createElement("button");
    btn.className = "cat-btn";
    btn.dataset.cat = cat.id;
    btn.innerHTML = `
      <span>${cat.icon || ""} ${cat.label}</span>
      <span class="count">${(cat.words || []).length}</span>
    `;
    categoryListEl.appendChild(btn);
  });

  document.querySelectorAll(".cat-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.cat === currentCategoryId);
  });
}

/***********************
 * å–®å­— HTMLï¼ˆå« ğŸ”Š + ç­‰ç´šå°æ¨™ï¼‰
 ***********************/
function wordHTML(w) {
  const safeEn  = String(w.en || "");
  const safePos = w.pos ? String(w.pos) : "";
  const safeZh  = w.zh ? String(w.zh) : "";
  const levelTag = w.levelShort
    ? `<span class="word-level-tag word-level-${w.levelId}">${w.levelShort}</span>`
    : "";

  return `
    <div class="word-cell">
      <div class="word-row">
        <div class="word-en-zh">
          ${levelTag}
          <span class="word-en">${safeEn}</span>
          ${safePos ? `<span class="word-pos">${safePos}</span>` : ""}
          ${safeZh ? `<span class="word-zh">${safeZh}</span>` : ""}
        </div>
        <button class="speak-btn" data-word="${safeEn}">ğŸ”Š</button>
      </div>
    </div>
  `;
}

/***********************
 * ä¸»å…§å®¹æ¸²æŸ“
 ***********************/
function renderContent() {
  const dataset    = DATASETS[currentLevel];
  const cats       = dataset.categories || [];
  const hasSearch  = normalize(searchKey);
  const levelLabel = LEVEL_CONFIG[currentLevel].label;

  /* ğŸ” æœå°‹æ¨¡å¼ï¼šè·¨ Starters / Movers / Flyers å…¨éƒ¨æœå°‹ */
  if (hasSearch) {
    const words = filteredWordsAllLevels(searchKey);
    panelTitleEl.textContent    = "æœå°‹çµæœï¼ˆå…¨éƒ¨ç­‰ç´šï¼‰";
    panelSubtitleEl.textContent = words.length ? `å…± ${words.length} ç­†` : "æ²’æœ‰ç¬¦åˆçš„å–®å­—";
    panelBadgeEl.textContent    = `Starters + Movers + Flyers Â· æœå°‹`;

    if (!words.length) {
      wordContentEl.innerHTML = `<div class="empty-state">ç›®å‰æ²’æœ‰ç¬¦åˆçš„å–®å­—</div>`;
      return;
    }

    wordContentEl.innerHTML = `
      <div class="word-grid">
        ${words.map(wordHTML).join("")}
      </div>
    `;
    return;
  }

  /* ä¸åˆ†é¡ï¼ˆflatï¼‰â†’ åªé¡¯ç¤ºç›®å‰ç­‰ç´šçš„å…¨éƒ¨å–®å­— */
  if (currentCategoryId === "flat") {
    const words = getAllWordsForCurrentLevel();
    panelTitleEl.textContent    = "å…¨éƒ¨å–®å­—ï¼ˆä¸åˆ†é¡ï¼‰";
    panelSubtitleEl.textContent = "";
    panelBadgeEl.textContent    = `${levelLabel} Â· ${words.length} è©`;

    wordContentEl.innerHTML = `
      <div class="word-grid">
        ${words.map(wordHTML).join("")}
      </div>
    `;
    return;
  }

  /* å…¨éƒ¨ä¸»é¡Œï¼ˆç›®å‰ç­‰ç´šï¼‰ */
  if (currentCategoryId === "all") {
    panelTitleEl.textContent    = "å…¨éƒ¨ä¸»é¡Œ";
    panelSubtitleEl.textContent = "";
    panelBadgeEl.textContent    = `${levelLabel}`;

    if (!cats.length) {
      wordContentEl.innerHTML = `<div class="empty-state">é€™å€‹ç­‰ç´šæš«ç„¡ä¸»é¡Œè³‡æ–™</div>`;
      return;
    }

    wordContentEl.innerHTML = `
      <div class="categories-container">
        ${cats.map(cat => `
          <section class="category-block">
            <div class="category-header-grid">
              <div class="category-name">
                <span class="icon">${cat.icon || ""}</span>
                <span>${cat.label}</span>
              </div>
            </div>
            <div class="word-grid">
              ${(cat.words || []).map(w => 
                wordHTML({
                  ...w,
                  levelId: currentLevel,
                  levelLabel,
                  levelShort: LEVEL_CONFIG[currentLevel].short
                })
              ).join("")}
            </div>
          </section>
        `).join("")}
      </div>
    `;
    return;
  }

  /* å–®ä¸€ä¸»é¡Œï¼ˆç›®å‰ç­‰ç´šï¼‰ */
  const cat = cats.find(c => c.id === currentCategoryId);
  if (!cat) {
    wordContentEl.innerHTML = `<div class="empty-state">æ‰¾ä¸åˆ°é€™å€‹ä¸»é¡Œ</div>`;
    return;
  }

  panelTitleEl.textContent    = cat.label;
  panelSubtitleEl.textContent = "";
  panelBadgeEl.textContent    = `${levelLabel} Â· ${(cat.words || []).length} è©`;

  wordContentEl.innerHTML = `
    <section class="category-block">
      <div class="category-header-grid">
        <div class="category-name">
          <span class="icon">${cat.icon || ""}</span>
          <span>${cat.label}</span>
        </div>
      </div>
      <div class="word-grid">
        ${(cat.words || []).map(w => 
          wordHTML({
            ...w,
            levelId: currentLevel,
            levelLabel,
            levelShort: LEVEL_CONFIG[currentLevel].short
          })
        ).join("")}
      </div>
    </section>
  `;
}

/***********************
 * update
 ***********************/
function updateAll() {
  currentLevelLabel.textContent = LEVEL_CONFIG[currentLevel].label;
  levelTabs.forEach(tab => {
    tab.classList.toggle("active", tab.dataset.level === currentLevel);
  });
  renderCategoryButtons();
  renderContent();
}

/***********************
 * äº‹ä»¶ç¶å®š
 ***********************/
levelTabs.forEach(tab => {
  tab.addEventListener("click", () => {
    currentLevel      = tab.dataset.level;
    currentCategoryId = "all";
    searchKey         = "";
    searchBox.value   = "";
    updateAll();
  });
});

searchBox.addEventListener("input", () => {
  searchKey = searchBox.value;
  // æœ‰è¼¸å…¥å°±äº¤çµ¦ã€Œæœå°‹æ¨¡å¼ã€ï¼ŒcurrentCategoryId ä¿ç•™åŸæœ¬ä¹Ÿæ²’é—œä¿‚
  updateAll();
});

sidebar.addEventListener("click", (e) => {
  const btn = e.target.closest(".cat-btn");
  if (!btn) return;
  currentCategoryId = btn.dataset.cat;
  searchKey = "";
  searchBox.value = "";
  updateAll();
});

printBtn.addEventListener("click", () => {
  window.print();
});

/***********************
 * åˆå§‹åŒ–
 ***********************/
updateAll();
</script>


</body>
</html>
